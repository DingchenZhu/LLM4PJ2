# æ·±åº¦å­¦ä¹ åŸºç¡€è¯¾ç¨‹å®éªŒ2
## é¡¹ç›®ä»‹ç»
æœ¬é¡¹ç›®åŸºäºæ·±åº¦å­¦ä¹ åŸºç¡€ï¼ˆç”±å¼ ç£Šè€å¸ˆå¼€è®¾ï¼Œè¯¾ç¨‹ä»£ç ä¸ºAIB310003ï¼‰ç›¸å…³å·¥ç¨‹åŸºç¡€è¿›è¡Œæ™ºèƒ½ä½“çš„æ„å»ºä¸æ–°å·¥å…·çš„å®ç°
## é¡¹ç›®è¯´æ˜
æœ¬æ¬¡å®éªŒï¼š
* ä½¿ç”¨LangChainæ„å»ºå·¥å…·å¢å¼ºçš„å¤§è¯­è¨€æ¨¡å‹æ™ºèƒ½ä½“
* åŸºäºå®éªŒä¸€çš„æ¨¡å‹ï¼Œå°è¯•å°†å…¶è½¬æ¢ä¸ºæ¨¡å‹æ–‡ä»¶ï¼Œä¿å­˜ä¸º.h5æ ¼å¼æ–‡ä»¶ï¼Œå°†è¯¥æ¨¡å‹ä½œä¸ºå·¥å…·é›†æˆåˆ°æ™ºèƒ½ä½“ä¸­
* åŸºäºå·¥å…·è¿”å›ç»“æœé©±åŠ¨ LLM è¿›è¡Œè¿›ä¸€æ­¥æ¨ç†ä¸å»ºè®®ç”Ÿæˆ

## å…·ä½“ç›®æ ‡ä¸å®ç°
### ç›®æ ‡ 1ï¼šç†Ÿæ‚‰æ™ºèƒ½ä½“æ„å»ºæ­¥éª¤
#### ç›®æ ‡è¦æ±‚ï¼š
1. è·å–API
2. å°†PJ1ä¸­çš„æ¨¡å‹è½¬æ¢ä¸ºæ¨¡å‹æ–‡ä»¶ï¼Œæ ¹æ®APIæ–‡æ¡£å¡«å†™api keyå’Œbase urlï¼Œåœ¨æœ¬åœ°æœºå™¨è¿è¡Œç¤ºä¾‹ä»£ç 
3. å­¦ä¹ å’Œç†è§£ç¤ºä¾‹ä»£ç æ¯ä¸ªå‡½æ•°/æ¨¡å—çš„åŠŸèƒ½å’Œç”¨æ³•

#### ç›®æ ‡å®ç°

1. ç¬¬ä¸€æ­¥æ¯”è¾ƒç®€å•ï¼Œå› æ­¤è·³è¿‡ï¼Œæ³¨å†Œé¢†å–å°±å¯ä»¥äº†
2. ç¬¬äºŒæ­¥ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆæ ¹æ®ä¹‹å‰çš„æ¨¡å‹ä¹Ÿå°±æ˜¯pj1ä¸­çš„CNNç½‘ç»œæ¨¡å‹ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨æ€§èƒ½è¡¨ç°æœ€å¥½çš„æ¨¡å‹è¿›è¡Œå®éªŒï¼Œæ¨¡å‹çš„å…·ä½“ä»£ç è§ä¸‹æ–¹
```python
def create_model_1():
    model = models.Sequential([
        layers.Conv2D(32, (5, 5), activation='relu', input_shape=(150, 150, 3)),
        layers.Conv2D(32, (3, 3), activation='relu'),         
       
        layers.MaxPooling2D((3, 3)),
       
        layers.Conv2D(64, (3, 3), activation='relu'),
        layers.Conv2D(64, (3, 3), activation='relu'),         
       
        layers.MaxPooling2D((3, 3)),
        layers.Flatten(),
        layers.Dense(128, activation='relu'),
        layers.Dense(1, activation='sigmoid')
    ])
    return model
```
ç›¸å…³çš„æ€§èƒ½è¡¨ç°è§ä¸‹å›¾ï¼š
![img.png](img.png)

åœ¨è¿™é‡Œç›´æ¥ä½¿ç”¨è¯­å¥saveä¿å­˜
```python
model.save("pneumonia_model.h5")
```
å¾—åˆ°h5æ¨¡å‹æ–‡ä»¶ï¼Œå°†å…¶æ”¾åœ¨å½“å‰é¡¹ç›®ä¸‹

æ­¤å¤„ä½¿ç”¨test.pyæ–‡ä»¶æµ‹è¯•è¯¥æ¨¡å‹æ˜¯å¦èƒ½ä½¿ç”¨

æµ‹è¯•è¯­å¥å¦‚ä¸‹æ‰€ç¤ºï¼š
```python
import tensorflow as tf
import numpy as np
from PIL import Image

model = tf.keras.models.load_model("pneumonia_model.h5", compile=False)

img = Image.open("test_example.jpeg").convert("RGB").resize((150, 150))
arr = np.expand_dims(np.array(img) / 255.0, axis=0)

prob = model.predict(arr)[0][0]
print("è‚ºç‚æ¦‚ç‡ï¼š", prob)
```
ä½†æ˜¯æŠ¥é”™äº†ã€‚ã€‚ã€‚å‘ç°æ˜¯ç‰ˆæœ¬ä¸å…¼å®¹é—®é¢˜
![img_1.png](img_1.png)

å“ˆå“ˆï¼Œè¿™é‡Œæ˜¯ç‰ˆæœ¬ä¸å…¼å®¹é—®é¢˜ï¼Œæˆ‘å¾ˆå¥½å¥‡ä¹‹å‰çš„å®éªŒæ˜¯å¦‚ä½•åšåˆ°ï¼š

ä½¿ç”¨tensorflow 2.19.0 ï¼Œå¿…é¡»è¦keras>=3.5.0æ‰èƒ½å…¼å®¹çš„pj1ï¼Œåœ¨pj2ä½¿ç”¨äº†keras==2.11.0ï¼Œæ‰€ä»¥è¿™ä¸ªäº‹æƒ…æ¯”è¾ƒä»¤äººè¿·æƒ‘ï¼Œä¹Ÿå¯èƒ½æ˜¯é„™äººæ‰ç–å­¦æµ…ã€‚

anywayï¼Œäºæ˜¯å†³å®šåœ¨keras = 2.11.0çš„ç‰ˆæœ¬ä¸‹ï¼Œé‡æ–°è®­ç»ƒæ¨¡å‹ï¼Œå¾—åˆ°å¦‚ä¸‹ç»“æœï¼š
![img_2.png](img_2.png)
---
**ä»£ç ç†è§£ï¼š**

é¦–å…ˆæ˜¯é¢„æµ‹å‡½æ•°ï¼š
```python
def predict_pneumonia(image_path: str) -> str:
    """æ ¹æ®æä¾›çš„å›¾åƒè·¯å¾„ï¼Œåˆ¤æ–­æ˜¯å¦å­˜åœ¨è‚ºç‚è¿¹è±¡ã€‚è¾“å…¥åº”ä¸ºå›¾åƒè·¯å¾„å­—ç¬¦ä¸²ã€‚"""
    print("ğŸ§ª è°ƒç”¨è‚ºç‚è¯†åˆ«æ¨¡å‹ï¼Œè¾“å…¥è·¯å¾„ï¼š", image_path)
    model = tf.keras.models.load_model("pneumonia_model.h5")
    img = Image.open(image_path).convert("RGB").resize((150, 150))
    arr = np.expand_dims(np.array(img) / 255.0, axis=0)
    prob = model.predict(arr)[0][0]
    result = f"å›¾åƒè¯Šæ–­ç»“æœï¼š{'è‚ºç‚' if prob > 0.5 else 'æ­£å¸¸'}ï¼ˆæ¦‚ç‡={prob:.2f}ï¼‰"
    print("âœ… æ¨¡å‹è¾“å‡ºï¼š", result)
    return result
```
è¿™æ®µå‡½æ•°æ¥å—äº†è¾“å…¥å›¾åƒçš„è·¯å¾„ï¼Œè¿”å›ä¸€ä¸ªstrç±»å‹ï¼Œç”¨äºè¯´æ˜ç»“æœï¼Œé¦–å…ˆäº¤äº’è®©ç”¨æˆ·è¾“å…¥è·¯å¾„ï¼Œå†åŠ è½½è®­ç»ƒå¥½çš„æ¨¡å‹ï¼Œåœ¨è¿™é‡Œæ˜¯.h5æ–‡ä»¶

ç„¶åè¿›è¡Œå›¾åƒçš„é¢„å¤„ç†ï¼Œè¿›è€Œé¢„æµ‹è‚ºç‚çš„æ¦‚ç‡ï¼Œæœ¬äººè®¤ä¸ºè¿™æ®µå‡½æ•°å°±æ˜¯ä¾›æ™ºèƒ½ä½“è°ƒç”¨çš„é¢„æµ‹å‡½æ•°ï¼Œè¾ƒä¸ºç®€å•

ç„¶åæ˜¯æ™ºèƒ½ä½“æ„å»ºå‡½æ•°ï¼š
```python
def build_agent():
    print("ğŸ¤– æ„å»º Agent ä¸­...")
    llm = ChatOpenAI(
        model="qwen-plus",
        api_key="xxxx",
        base_url="https://dashscope.aliyuncs.com/compatible-mode/v1"
    )

    prompt = ChatPromptTemplate.from_template(
        """ä½ æ˜¯ä¸€ä¸ªåŒ»å­¦æ™ºèƒ½ä½“ï¼Œæœ‰ä»¥ä¸‹å·¥å…·å¯ä¾›ä½¿ç”¨ï¼š

å·¥å…·åˆ—è¡¨ï¼š
{tools}

å·¥å…·åç§°ï¼š
{tool_names}

ä½ çš„èŒè´£ï¼š
- å·¥å…·åªè°ƒç”¨ä¸€æ¬¡
- å·¥å…·è°ƒç”¨å®Œæˆåï¼Œè¯·æ ¹æ®è¿”å›ç»“æœç”Ÿæˆæ€»ç»“ï¼Œä¸è¦é‡å¤è°ƒç”¨å·¥å…·
- ç›´æ¥ç”¨ Final Answer ç»™å‡ºè¯Šæ–­ç»“è®º

ç”¨æˆ·è¾“å…¥ï¼š
{input}

{agent_scratchpad}
""")

    agent = create_react_agent(llm=llm, tools=[pneumonia_tool], prompt=prompt)
    print("âœ… Agent æ„å»ºå®Œæˆ")
    return AgentExecutor(agent=agent, tools=[pneumonia_tool], verbose=False, handle_parsing_errors=True,max_iterations=1000,max_execution_time=600)
```
è¿™ä¸ªå‡½æ•°å®šä¹‰äº†ä¸€ä¸ªbuild_agentçš„å‡½æ•°ï¼Œè¿”å›ä¸€ä¸ªæ™ºèƒ½ä½“æ‰§è¡Œå™¨çš„å¯¹è±¡(AgentExecutor)

ç¬¬ä¸€æ­¥åˆå§‹åŒ–å¤§é¢„è¨€æ¨¡å‹ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨äº†é˜¿é‡Œäº‘é€šä¹‰åƒé—®çš„å¤§æ¨¡å‹ï¼Œç›¸å…³apiå’Œbase urlå‚è€ƒå®˜æ–¹æ–‡æ¡£

ç¬¬äºŒæ­¥è®¾ç½®äº†promptçš„æ¨¡æ¿ï¼Œåœ¨è¿™é‡Œä½¿ç”¨äº†LangChainåˆ›å»ºäº†ä¸€ä¸ªæ™ºèƒ½ä½“çš„æ¨¡æ¿

ç¬¬ä¸‰æ­¥åˆ›å»ºäº†ReAct Agentï¼Œè¿™ä¸ªAgentä¼šåŸºäºç”¨æˆ·è¾“å…¥å’Œ Prompt å†³å®šæ˜¯å¦è°ƒç”¨å·¥å…·ï¼Œå¹¶è¿”å›ç»“æœã€‚

ç¬¬å››æ­¥è¿›è¡Œäº†æ™ºèƒ½ä½“çš„åŒ…è£…ï¼Œè®¾å®šäº†ä¸€äº›configurationï¼Œæ¯”å¦‚æ¨ç†æ­¥é•¿ï¼Œè¿è¡Œæ—¶é•¿ï¼Œæ—¥å¿—æ‰“å°ç­‰

ä¸è¿‡å‚è€ƒäº†æ–‡æ¡£ï¼Œè¿™é‡Œçš„apiæœ€å¥½è¿˜æ˜¯ä¸èƒ½ç”¨ä¸Šè¿°çš„ç¡¬ç¼–ç ï¼Œå› æ­¤ä½¿ç”¨äº†ç¯å¢ƒå˜é‡è¿›è¡Œè°ƒç”¨
```python
api_key=os.getenv("DASHSCOPE_API_KEY"),
```
æ‰€ä»¥åœ¨windowsç¯å¢ƒä¸‹ï¼Œè®¾ç½®äº†ä¸€ä¸‹ç¯å¢ƒå˜é‡ï¼š
```cmd
setx DASHSCOPE_API_KEY "xxxx"
```
ç„¶åæ£€éªŒä¸€ä¸‹æœ‰æ²¡æœ‰è®¾ç½®æˆåŠŸï¼š
```cmd
echo %DASHSCOPE_API_KEY%
```
æœ€åæ˜¯ç”¨Streamlitåˆ›å»ºå›¾å½¢åŒ–Webç•Œé¢ï¼š
è¿™æ®µä»£ç ä¸éœ€è¦è¿‡å¤šç†è§£äº†ï¼ŒåŸºæœ¬å°±æ˜¯å‰ç«¯çš„è®¾è®¡ä»£ç 

ä¸‹é¢æ˜¯è¿è¡Œç»“æœï¼š

é¦–å…ˆè¿è¡Œmainå‡½æ•°ï¼Œæ„å»ºäº†ä¸€ä¸ªè‚ºç‚è¯Šæ–­çš„æ™ºèƒ½ä½“ï¼Œç„¶åé€šè¿‡å‘½ä»¤è¡Œï¼š
```python
 streamlit run E:\PROJECT\Project2\main.py
```
å¯åŠ¨äº†streamlitçš„å‰ç«¯ç•Œé¢ï¼Œè¿™é‡Œä½¿ç”¨äº†Edgeæµè§ˆå™¨è¿›è¡Œæ‰“å¼€ï¼Œç•Œé¢æ˜¯è¿™æ ·çš„ï¼š
![img_4.png](img_4.png)

ç»ˆç«¯è¿è¡Œç•Œé¢ä¸ºï¼š
![img_6.png](img_6.png)

ä¸Šä¼ äº†ä¸€å¼ æµ‹è¯•å›¾åƒï¼Œå¾—åˆ°ç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š

![img_5.png](img_5.png)

### ç›®æ ‡ 2ï¼šåˆ›å»ºæ–°å·¥å…·ä¾›æ™ºèƒ½ä½“ä½¿ç”¨

åœ¨è¿™é‡Œé¦–å…ˆåˆ›å»ºä¸€ä¸ªå·¥å…·ï¼š
```python
@tool
def prevention_advice(_: str) -> str:
    """
    æä¾›é¢„é˜²çš„å»ºè®®
    æ„Ÿè§‰ä¸éœ€è¦è¾“å…¥å‚æ•°ï¼Œå°±ç”¨_ä»£æ›¿å§
    """
    advice = (
        "è‚ºç‚é¢„é˜²å»ºè®®ï¼š\n"
        "ä¸€å®šä¸€å®šè®°å¾—åŠ å¼ºé”»ç‚¼ï¼Œèº«ä½“æ‰æ˜¯é©å‘½çš„æœ¬é’±\n"
        "æ¥ç§è‚ºç‚ç–«è‹—\n"
        "åœ¨æµæ„Ÿå­£èŠ‚å‡å°‘å»äººå¤šå¯†é›†åœºæ‰€\n"
        "æ³¨æ„å±…ä½ç¯å¢ƒé€šé£"
    )
```
ç„¶åä¸ºäº†å’Œé¢„æµ‹å‡½æ•°äº§ç”Ÿå…³è”ï¼Œåœ¨è¿™é‡Œä¿®æ”¹é¢„æµ‹å‡½æ•°ï¼š
```python
def predict_pneumonia(image_path: str) -> str:
    """æ ¹æ®æä¾›çš„å›¾åƒè·¯å¾„ï¼Œåˆ¤æ–­æ˜¯å¦å­˜åœ¨è‚ºç‚è¿¹è±¡ã€‚è¾“å…¥åº”ä¸ºå›¾åƒè·¯å¾„å­—ç¬¦ä¸²ã€‚"""
    print("ğŸ§ª è°ƒç”¨è‚ºç‚è¯†åˆ«æ¨¡å‹ï¼Œè¾“å…¥è·¯å¾„ï¼š", image_path)
    model = tf.keras.models.load_model("pneumonia_model.h5")
    img = Image.open(image_path).convert("RGB").resize((150, 150))
    arr = np.expand_dims(np.array(img) / 255.0, axis=0)
    prob = model.predict(arr)[0][0]
    # result = f"å›¾åƒè¯Šæ–­ç»“æœï¼š{'è‚ºç‚' if prob > 0.5 else 'æ­£å¸¸'}ï¼ˆæ¦‚ç‡={prob:.2f}ï¼‰"
    if prob > 0.5:
        result = f"å›¾åƒè¯Šæ–­ç»“æœï¼šè‚ºç‚ï¼ˆæ¦‚ç‡={prob:.2f}ï¼‰"
    else:
        advice = prevention_advice()  # è‡ªåŠ¨è°ƒç”¨å»ºè®®å·¥å…·
        result = f"å›¾åƒè¯Šæ–­ç»“æœï¼šæ­£å¸¸ï¼ˆæ¦‚ç‡={prob:.2f}ï¼‰\n\n{advice}"
    print("âœ… æ¨¡å‹è¾“å‡ºï¼š", result)
    return result
```

æœ€åæ³¨å†Œå·¥å…·åˆ°æ™ºèƒ½ä½“ä¸­ï¼š
```python
agent = create_react_agent(llm=llm, tools=[pneumonia_tool], prompt=prompt)
print("âœ… Agent æ„å»ºå®Œæˆ")
return AgentExecutor(agent=agent, tools=[pneumonia_tool], verbose=False, handle_parsing_errors=True,max_iterations=1000,max_execution_time=600)
```
åœ¨è¿™é‡Œå°†[pneumonia_tool]ä¿®æ”¹ä¸ºï¼š
```python
# pneumonia_tool = predict_pneumonia
pneumonia_tool = predict_pneumonia, prevention_advice
```
ä½†æ˜¯å‡ºç°äº†ä¸å°‘é—®é¢˜ï¼Œæœ€ç»ˆè¿˜æ˜¯è·‘å‡ºæ¥äº†ã€‚

![img_7.png](img_7.png)

è®°å½•ä¸€äº›é—®é¢˜çš„è§£å†³ï¼š
1. å‡ºç°æ™ºèƒ½ä½“è‡ªå·±èƒ¡ç¼–ä¹±é€ ï¼šä¸€ç›´ä¸å‡ºç°æ­£ç¡®è°ƒç”¨å·¥å…·çš„æ˜¾ç¤ºï¼Œä¸ç®¡è¾“å…¥ä»€ä¹ˆå›¾åƒéƒ½æ˜¯è¯´æœ‰è‚ºç‚ï¼š

åœ¨è¿™é‡Œéœ€è¦æŸ¥çœ‹å·¥å…·æ˜¯å¦æ³¨å†ŒæˆåŠŸï¼ŒåŒæ—¶æœ€é‡è¦çš„æ˜¯ï¼Œè¿™ä¸ªpromptçš„é—®é¢˜æ¯”è¾ƒå¤§ï¼Œéœ€è¦é‡æ–°ä¿®æ”¹ï¼š

**ä¸»è¦é—®é¢˜æ˜¯ï¼šPrompt æ²¡æœ‰æŒ‡å¯¼æ™ºèƒ½ä½“å¦‚ä½•è°ƒç”¨å·¥å…·ï¼ˆç¼ºå°‘ REACT æ¨¡å¼ç¤ºèŒƒï¼‰**
```python
    prompt = ChatPromptTemplate.from_template(
        """ä½ æ˜¯ä¸€ä¸ªåŒ»å­¦å½±åƒåˆ†æåŠ©æ‰‹ï¼Œä½ æœ‰ä»¥ä¸‹å·¥å…·å¯ä»¥ä½¿ç”¨ï¼š

{tools}
å·¥å…·åç§°ï¼š
{tool_names}

ä½ ä¼šæŒ‰ç…§ä¸‹é¢çš„æ ¼å¼æ¥å›åº”ï¼š

Question: ç”¨æˆ·çš„é—®é¢˜
Thought: ä½ å¯¹é—®é¢˜çš„ç†è§£ï¼Œä»¥åŠä¸‹ä¸€æ­¥çš„è®¡åˆ’
Action: ä½ è¦è°ƒç”¨çš„å·¥å…·åç§°
Action Input: ä¼ ç»™å·¥å…·çš„è¾“å…¥
Observation: å·¥å…·è¿”å›çš„ç»“æœ
...ï¼ˆå¯èƒ½ç»§ç»­ Thought â†’ Action â†’ Action Input â†’ Observationï¼‰
Final Answer: æœ€ç»ˆç»™ç”¨æˆ·çš„å›ç­”

ç°åœ¨å¼€å§‹ï¼

Question: {input}
{agent_scratchpad}
""")
```
å› æ­¤å°†å…¶ä¿®æ”¹ä¸ºå¦‚ä¸Špromptï¼Œè¿™æ ·å¯ä»¥æ›´å¥½åœ°æŒ‡å¯¼æ™ºèƒ½ä½“è¿›è¡Œæ€è€ƒå’Œè°ƒç”¨å·¥å…·å¹¶è¾“å‡º

2.è°ƒç”¨å·¥å…·çš„æ—¶å€™è¿”å›é”™è¯¯å€¼ï¼ŒåŒæ—¶ä¼šæŠ¥é”™



